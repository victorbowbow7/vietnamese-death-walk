<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Vietnamese Death Walk</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box;touch-action:none;-webkit-touch-callout:none;-webkit-user-select:none;user-select:none}
body{overflow:hidden;background:#1a1a2e;font-family:'Arial Black',Arial,sans-serif}
#gameCanvas{display:block;width:100vw;height:100vh}
#ui{position:fixed;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:100}
#startScreen{position:absolute;top:0;left:0;width:100%;height:100%;background:linear-gradient(135deg,#1a1a2e 0%,#16213e 50%,#0f3460 100%);display:flex;flex-direction:column;justify-content:center;align-items:center;pointer-events:auto;z-index:200}
#startScreen h1{color:#e94560;font-size:clamp(2rem,8vw,4rem);text-shadow:0 0 20px #e94560,3px 3px 0 #000;margin-bottom:10px;text-align:center;transform:rotate(-2deg)}
#startScreen .subtitle{color:#ffd700;font-size:clamp(1rem,4vw,1.5rem);margin-bottom:30px;text-shadow:2px 2px 4px rgba(0,0,0,0.5)}
#startBtn{padding:20px 50px;font-size:clamp(1.2rem,5vw,2rem);background:linear-gradient(145deg,#e94560,#c23a51);color:white;border:none;border-radius:15px;cursor:pointer;box-shadow:0 8px 0 #8b2638,0 15px 30px rgba(0,0,0,0.4);transition:all 0.1s;text-transform:uppercase;font-weight:bold;pointer-events:auto}
#startBtn:active{transform:translateY(4px);box-shadow:0 4px 0 #8b2638,0 8px 15px rgba(0,0,0,0.4)}
#hud{position:absolute;top:10px;left:10px;right:10px;display:flex;justify-content:space-between;pointer-events:none}
.hudPanel{background:rgba(0,0,0,0.7);padding:10px 20px;border-radius:10px;color:white;font-size:clamp(0.9rem,3vw,1.2rem);border:2px solid #e94560}
.lives{color:#e94560}
#controls{position:absolute;bottom:20px;left:50%;transform:translateX(-50%);display:flex;gap:15px;pointer-events:auto;z-index:150}
.controlBtn{width:clamp(55px,15vw,70px);height:clamp(55px,15vw,70px);border-radius:50%;border:3px solid rgba(255,255,255,0.8);background:rgba(233,69,96,0.8);color:white;font-size:clamp(1.2rem,4vw,1.8rem);cursor:pointer;display:flex;align-items:center;justify-content:center;box-shadow:0 5px 15px rgba(0,0,0,0.4),inset 0 2px 5px rgba(255,255,255,0.3);transition:all 0.1s}
.controlBtn:active{transform:scale(0.9);background:rgba(233,69,96,1)}
.controlBtn.dash{background:rgba(255,215,0,0.8);color:#000;font-weight:bold;font-size:clamp(0.9rem,3vw,1.2rem)}
.controlBtn.dash:active{background:rgba(255,215,0,1)}
#deathFlash{position:absolute;top:0;left:0;width:100%;height:100%;background:rgba(255,0,0,0.5);opacity:0;pointer-events:none;transition:opacity 0.2s;z-index:180}
#deathFlash.active{opacity:1}
#endScreen{position:absolute;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.85);display:none;flex-direction:column;justify-content:center;align-items:center;pointer-events:auto;z-index:200}
#endScreen h2{color:#ffd700;font-size:clamp(2rem,8vw,3.5rem);margin-bottom:20px;text-shadow:0 0 20px #ffd700}
#endScreen .finalScore{color:white;font-size:clamp(1.2rem,4vw,1.8rem);margin-bottom:30px}
#restartBtn{padding:15px 40px;font-size:clamp(1rem,4vw,1.5rem);background:linear-gradient(145deg,#4ecca3,#3db892);color:white;border:none;border-radius:10px;cursor:pointer;box-shadow:0 6px 0 #2a8b6b,0 10px 20px rgba(0,0,0,0.3);transition:all 0.1s;font-weight:bold}
#restartBtn:active{transform:translateY(3px);box-shadow:0 3px 0 #2a8b6b,0 5px 10px rgba(0,0,0,0.3)}
.swipeArea{position:absolute;top:0;left:0;width:100%;height:calc(100% - 120px);pointer-events:auto;z-index:50}
</style>
</head>
<body>
<div id="gameCanvas"></div>
<div id="ui">
<div id="startScreen">
<h1>üáªüá≥ DEATH WALK</h1>
<p class="subtitle">Cross 8 lanes of Vietnamese traffic</p>
<button id="startBtn">START GAME</button>
</div>
<div id="hud" style="display:none">
<div class="hudPanel"><span class="lives">‚ù§Ô∏è <span id="livesDisplay">3</span></span></div>
<div class="hudPanel">Score: <span id="scoreDisplay">0</span></div>
</div>
<div class="swipeArea" id="swipeArea"></div>
<div id="controls" style="display:none">
<button class="controlBtn" id="btnLeft">‚¨ÖÔ∏è</button>
<button class="controlBtn" id="btnForward">‚¨ÜÔ∏è</button>
<button class="controlBtn" id="btnBackward">‚¨áÔ∏è</button>
<button class="controlBtn" id="btnRight">‚û°Ô∏è</button>
<button class="controlBtn dash" id="btnDash">‚ö°<br>DASH</button>
</div>
<div id="deathFlash"></div>
<div id="endScreen">
<h2 id="endTitle">GAME OVER</h2>
<p class="finalScore" id="finalScore">Final Score: 0</p>
<button id="restartBtn">PLAY AGAIN</button>
</div>
</div>

<script>
const state={isPlaying:false,lives:3,score:0,startTime:0,isDashing:false,dashCooldown:0,keys:{forward:false,backward:false,left:false,right:false},cameraAngle:{x:0.3,y:0},targetCameraAngle:{x:0.3,y:0}};

const scene=new THREE.Scene();
scene.fog=new THREE.FogExp2(0xff8c42,0.015);
const camera=new THREE.PerspectiveCamera(60,window.innerWidth/window.innerHeight,0.1,1000);
const renderer=new THREE.WebGLRenderer({antialias:true,alpha:false});
renderer.setSize(window.innerWidth,window.innerHeight);
renderer.shadowMap.enabled=true;
renderer.shadowMap.type=THREE.PCFSoftShadowMap;
renderer.setClearColor(0xff6b35);
document.getElementById('gameCanvas').appendChild(renderer.domElement);

const ambientLight=new THREE.AmbientLight(0xffaa77,0.4);
scene.add(ambientLight);
const sunLight=new THREE.DirectionalLight(0xff6b35,0.8);
sunLight.position.set(-50,30,-50);
sunLight.castShadow=true;
sunLight.shadow.mapSize.width=2048;
sunLight.shadow.mapSize.height=2048;
sunLight.shadow.camera=new THREE.OrthographicCamera(-50,50,50,-50,0.5,200);
scene.add(sunLight);
const orangeLight=new THREE.DirectionalLight(0xff4500,0.3);
orangeLight.position.set(30,20,30);
scene.add(orangeLight);

const materials={
road:new THREE.MeshLambertMaterial({color:0x333333}),
laneLine:new THREE.MeshBasicMaterial({color:0xffffff}),
sidewalk:new THREE.MeshLambertMaterial({color:0x888888}),
building:new THREE.MeshLambertMaterial({color:0x666666}),
buildingWindow:new THREE.MeshBasicMaterial({color:0x87ceeb,transparent:true,opacity:0.7}),
player:new THREE.MeshLambertMaterial({color:0x00ff00}),
wheel:new THREE.MeshLambertMaterial({color:0x222222}),
motorbikeBody:new THREE.MeshLambertMaterial({color:0xe74c3c}),
carBody:new THREE.MeshLambertMaterial({color:0x3498db}),
busBody:new THREE.MeshLambertMaterial({color:0xf39c12}),
glass:new THREE.MeshBasicMaterial({color:0x87ceeb,transparent:true,opacity:0.5}),
headlight:new THREE.MeshBasicMaterial({color:0xffffaa}),
taillight:new THREE.MeshBasicMaterial({color:0xff0000})
};

const playerGroup=new THREE.Group();
const playerBody=new THREE.Mesh(new THREE.CylinderGeometry(0.3,0.3,1.2,8),materials.player);
playerBody.position.y=0.6;playerBody.castShadow=true;playerGroup.add(playerBody);
const playerHead=new THREE.Mesh(new THREE.SphereGeometry(0.25,8,8),new THREE.MeshLambertMaterial({color:0xffccaa}));
playerHead.position.y=1.35;playerHead.castShadow=true;playerGroup.add(playerHead);
const leftArm=new THREE.Mesh(new THREE.CylinderGeometry(0.1,0.1,0.8,6),materials.player);
leftArm.position.set(-0.4,0.8,0);leftArm.rotation.z=0.2;playerGroup.add(leftArm);
const rightArm=new THREE.Mesh(new THREE.CylinderGeometry(0.1,0.1,0.8,6),materials.player);
rightArm.position.set(0.4,0.8,0);rightArm.rotation.z=-0.2;playerGroup.add(rightArm);
const leftLeg=new THREE.Mesh(new THREE.CylinderGeometry(0.12,0.1,0.8,6),new THREE.MeshLambertMaterial({color:0x333333}));
leftLeg.position.set(-0.15,0.4,0);playerGroup.add(leftLeg);
const rightLeg=new THREE.Mesh(new THREE.CylinderGeometry(0.12,0.1,0.8,6),new THREE.MeshLambertMaterial({color:0x333333}));
rightLeg.position.set(0.15,0.4,0);playerGroup.add(rightLeg);
scene.add(playerGroup);

function createWheel(x,y,z){
const wheel=new THREE.Mesh(new THREE.CylinderGeometry(0.25,0.25,0.15,12),materials.wheel);
wheel.rotation.z=Math.PI/2;wheel.position.set(x,y,z);wheel.castShadow=true;return wheel;
}

function createMotorbike(){
const group=new THREE.Group();
group.add(createWheel(-0.6,0.25,0));group.add(createWheel(0.6,0.25,0));
const body=new THREE.Mesh(new THREE.BoxGeometry(1.4,0.4,0.4),materials.motorbikeBody);
body.position.set(0,0.5,0);body.castShadow=true;group.add(body);
const seat=new THREE.Mesh(new THREE.BoxGeometry(0.5,0.1,0.35),new THREE.MeshLambertMaterial({color:0x333333}));
seat.position.set(-0.1,0.75,0);group.add(seat);
const handlebar=new THREE.Mesh(new THREE.CylinderGeometry(0.03,0.03,0.5,6),new THREE.MeshLambertMaterial({color:0x888888}));
handlebar.rotation.x=Math.PI/2;handlebar.position.set(0.5,0.8,0);group.add(handlebar);
const headlight=new THREE.Mesh(new THREE.SphereGeometry(0.08,8,8),materials.headlight);
headlight.position.set(0.7,0.6,0);group.add(headlight);
const riderBody=new THREE.Mesh(new THREE.CylinderGeometry(0.2,0.2,0.7,8),new THREE.MeshLambertMaterial({color:0x2c3e50}));
riderBody.position.set(-0.1,1.1,0);riderBody.rotation.z=-0.2;group.add(riderBody);
const riderHead=new THREE.Mesh(new THREE.SphereGeometry(0.15,8,8),new THREE.MeshLambertMaterial({color:0xffccaa}));
riderHead.position.set(0,1.5,0);group.add(riderHead);
return group;
}

function createCar(color){
const group=new THREE.Group();
const bodyMat=new THREE.MeshLambertMaterial({color:color});
group.add(createWheel(-0.9,0.3,0.7));group.add(createWheel(0.9,0.3,0.7));
group.add(createWheel(-0.9,0.3,-0.7));group.add(createWheel(0.9,0.3,-0.7));
const lowerBody=new THREE.Mesh(new THREE.BoxGeometry(2.2,0.6,1.6),bodyMat);
lowerBody.position.set(0,0.6,0);lowerBody.castShadow=true;group.add(lowerBody);
const upperBody=new THREE.Mesh(new THREE.BoxGeometry(1.4,0.5,1.3),bodyMat);
upperBody.position.set(-0.1,1.15,0);upperBody.castShadow=true;group.add(upperBody);
const frontWindow=new THREE.Mesh(new THREE.PlaneGeometry(1.1,0.4),materials.glass);
frontWindow.position.set(0.61,1.15,0);frontWindow.rotation.y=Math.PI/2;group.add(frontWindow);
const backWindow=new THREE.Mesh(new THREE.PlaneGeometry(1.1,0.4),materials.glass);
backWindow.position.set(-0.81,1.15,0);backWindow.rotation.y=-Math.PI/2;group.add(backWindow);
const leftWindow=new THREE.Mesh(new THREE.PlaneGeometry(1.2,0.4),materials.glass);
leftWindow.position.set(-0.1,1.15,0.66);group.add(leftWindow);
const rightWindow=new THREE.Mesh(new THREE.PlaneGeometry(1.2,0.4),materials.glass);
rightWindow.position.set(-0.1,1.15,-0.66);rightWindow.rotation.y=Math.PI;group.add(rightWindow);
const leftHeadlight=new THREE.Mesh(new THREE.CircleGeometry(0.12,8),materials.headlight);
leftHeadlight.position.set(1.11,0.7,0.5);leftHeadlight.rotation.y=Math.PI/2;group.add(leftHeadlight);
const rightHeadlight=new THREE.Mesh(new THREE.CircleGeometry(0.12,8),materials.headlight);
rightHeadlight.position.set(1.11,0.7,-0.5);rightHeadlight.rotation.y=Math.PI/2;group.add(rightHeadlight);
const leftTaillight=new THREE.Mesh(new THREE.CircleGeometry(0.1,8),materials.taillight);
leftTaillight.position.set(-1.11,0.7,0.5);leftTaillight.rotation.y=-Math.PI/2;group.add(leftTaillight);
const rightTaillight=new THREE.Mesh(new THREE.CircleGeometry(0.1,8),materials.taillight);
rightTaillight.position.set(-1.11,0.7,-0.5);rightTaillight.rotation.y=-Math.PI/2;group.add(rightTaillight);
return group;
}

function createBus(){
const group=new THREE.Group();
const wheelPositions=[[-1.8,0.4],[-1.0,0.4],[1.0,0.4],[1.8,0.4]];
wheelPositions.forEach(pos=>{group.add(createWheel(pos[0],0.35,pos[1]));group.add(createWheel(pos[0],0.35,-pos[1]));});
const body=new THREE.Mesh(new THREE.BoxGeometry(4.5,1.8,2),materials.busBody);
body.position.set(0,1.2,0);body.castShadow=true;group.add(body);
const windows=new THREE.Mesh(new THREE.BoxGeometry(4.3,0.6,2.05),materials.glass);
windows.position.set(0,1.5,0);group.add(windows);
const windshield=new THREE.Mesh(new THREE.PlaneGeometry(1.8,0.8),materials.glass);
windshield.position.set(2.26,1.4,0);windshield.rotation.y=Math.PI/2;group.add(windshield);
for(let z of[-0.6,0.6]){
const headlight=new THREE.Mesh(new THREE.CircleGeometry(0.15,8),materials.headlight);
headlight.position.set(2.26,0.8,z);headlight.rotation.y=Math.PI/2;group.add(headlight);
}
return group;
}

const LANE_WIDTH=4,NUM_LANES=8,ROAD_WIDTH=LANE_WIDTH*NUM_LANES,ROAD_LENGTH=200;

const roadGeometry=new THREE.PlaneGeometry(ROAD_WIDTH,ROAD_LENGTH);
const road=new THREE.Mesh(roadGeometry,materials.road);
road.rotation.x=-Math.PI/2;road.receiveShadow=true;scene.add(road);

for(let i=1;i<NUM_LANES;i++){
const x=-ROAD_WIDTH/2+i*LANE_WIDTH;
const line=new THREE.Mesh(new THREE.PlaneGeometry(0.2,ROAD_LENGTH),materials.laneLine);
line.rotation.x=-Math.PI/2;line.position.set(x,0.02,0);scene.add(line);
}

const sidewalkWidth=6;
const leftSidewalk=new THREE.Mesh(new THREE.BoxGeometry(sidewalkWidth,0.3,ROAD_LENGTH),materials.sidewalk);
leftSidewalk.position.set(-ROAD_WIDTH/2-sidewalkWidth/2,0.15,0);leftSidewalk.receiveShadow=true;scene.add(leftSidewalk);
const rightSidewalk=new THREE.Mesh(new THREE.BoxGeometry(sidewalkWidth,0.3,ROAD_LENGTH),materials.sidewalk);
rightSidewalk.position.set(ROAD_WIDTH/2+sidewalkWidth/2,0.15,0);rightSidewalk.receiveShadow=true;scene.add(rightSidewalk);

function createBuilding(x,z,width,height,depth){
const building=new THREE.Mesh(new THREE.BoxGeometry(width,height,depth),materials.building);
building.position.set(x,height/2,z);building.castShadow=true;building.receiveShadow=true;return building;
}
function createWindow(x,y,z,width,height){
const window=new THREE.Mesh(new THREE.PlaneGeometry(width,height),materials.buildingWindow);
window.position.set(x,y,z);return window;
}

for(let z=-ROAD_LENGTH/2+10;z<ROAD_LENGTH/2-10;z+=15){
const height=8+Math.random()*12;
const building=createBuilding(-ROAD_WIDTH/2-sidewalkWidth-4,z,8,height,12);scene.add(building);
for(let wy=2;wy<height-1;wy+=3){
for(let wx=-2;wx<=2;wx+=2){const win=createWindow(-ROAD_WIDTH/2-sidewalkWidth-0.1,wy,z+wx,1.5,2);win.rotation.y=Math.PI/2;scene.add(win);}
}
const height2=8+Math.random()*12;
const building2=createBuilding(ROAD_WIDTH/2+sidewalkWidth+4,z+7,8,height2,12);scene.add(building2);
for(let wy=2;wy<height2-1;wy+=3){
for(let wx=-2;wx<=2;wx+=2){const win=createWindow(ROAD_WIDTH/2+sidewalkWidth+0.1,wy,z+7+wx,1.5,2);win.rotation.y=-Math.PI/2;scene.add(win);}
}
}

const startLine=new THREE.Mesh(new THREE.PlaneGeometry(ROAD_WIDTH+4,2),new THREE.MeshBasicMaterial({color:0xffffff}));
startLine.rotation.x=-Math.PI/2;startLine.position.set(0,0.03,ROAD_LENGTH/2-5);scene.add(startLine);
const finishLine=new THREE.Mesh(new THREE.PlaneGeometry(ROAD_WIDTH+4,2),new THREE.MeshBasicMaterial({color:0x00ff00}));
finishLine.rotation.x=-Math.PI/2;finishLine.position.set(0,0.03,-ROAD_LENGTH/2+10);scene.add(finishLine);
const bannerPole1=new THREE.Mesh(new THREE.CylinderGeometry(0.1,0.1,6),new THREE.MeshLambertMaterial({color:0x888888}));
bannerPole1.position.set(-ROAD_WIDTH/2,3,-ROAD_LENGTH/2+10);scene.add(bannerPole1);
const bannerPole2=new THREE.Mesh(new THREE.CylinderGeometry(0.1,0.1,6),new THREE.MeshLambertMaterial({color:0x888888}));
bannerPole2.position.set(ROAD_WIDTH/2,3,-ROAD_LENGTH/2+10);scene.add(bannerPole2);
const banner=new THREE.Mesh(new THREE.BoxGeometry(ROAD_WIDTH,1,0.2),new THREE.MeshBasicMaterial({color:0x00ff00}));
banner.position.set(0,5.5,-ROAD_LENGTH/2+10);scene.add(banner);

const vehicles=[];
const vehicleColors=[0xe74c3c,0x3498db,0x2ecc71,0xf39c12,0x9b59b6,0x1abc9c];

function spawnVehicle(laneIndex){
const laneX=-ROAD_WIDTH/2+laneIndex*LANE_WIDTH+LANE_WIDTH/2;
const direction=laneIndex%2===0?1:-1;
let vehicle;
const type=Math.random();
if(type<0.5){vehicle=createMotorbike();vehicle.userData={type:'motorbike',width:1.4,length:0.8,speed:8+Math.random()*4};}
else if(type<0.85){vehicle=createCar(vehicleColors[Math.floor(Math.random()*vehicleColors.length)]);vehicle.userData={type:'car',width:2.2,length:1.6,speed:5+Math.random()*3};}
else{vehicle=createBus();vehicle.userData={type:'bus',width:4.5,length:2,speed:3+Math.random()*2};}
vehicle.userData.lane=laneIndex;vehicle.userData.direction=direction;
const z=direction>0?-ROAD_LENGTH/2-10:ROAD_LENGTH/2+10;
vehicle.position.set(laneX,0,z);
if(direction<0)vehicle.rotation.y=Math.PI;
scene.add(vehicle);vehicles.push(vehicle);
}

function updateVehicles(dt){
for(let i=vehicles.length-1;i>=0;i--){
const v=vehicles[i];
const speed=v.userData.speed*(state.isDashing?0.5:1);
v.position.z+=v.userData.direction*speed*dt;
if(Math.abs(v.position.z)>ROAD_LENGTH/2+15){scene.remove(v);vehicles.splice(i,1);}
}
}

const START_POS={x:0,z:ROAD_LENGTH/2-5};
function resetPlayer(){playerGroup.position.set(START_POS.x,0,START_POS.z);playerGroup.rotation.y=0;}

function startGame(){
state.isPlaying=true;state.lives=3;state.score=0;state.startTime=Date.now();
resetPlayer();vehicles.forEach(v=>scene.remove(v));vehicles.length=0;
document.getElementById('startScreen').style.display='none';
document.getElementById('endScreen').style.display='none';
document.getElementById('hud').style.display='flex';
document.getElementById('controls').style.display='flex';
document.getElementById('livesDisplay').textContent=state.lives;
document.getElementById('scoreDisplay').textContent='0';
}

function die(){
state.lives--;
document.getElementById('livesDisplay').textContent=state.lives;
const flash=document.getElementById('deathFlash');
flash.classList.add('active');
setTimeout(()=>flash.classList.remove('active'),300);
if(state.lives<=0)endGame(false);
else resetPlayer();
}

function endGame(win){
state.isPlaying=false;
const endScreen=document.getElementById('endScreen');
const endTitle=document.getElementById('endTitle');
const finalScore=document.getElementById('finalScore');
endTitle.textContent=win?'üéâ YOU SURVIVED!':'üíÄ GAME OVER';
endTitle.style.color=win?'#00ff00':'#ff0000';
const timeBonus=Math.floor((Date.now()-state.startTime)/1000)*10;
const distanceBonus=Math.floor((START_POS.z-playerGroup.position.z))*5;
state.score=timeBonus+distanceBonus;
finalScore.textContent='Final Score: '+state.score;
endScreen.style.display='flex';
}

function checkCollisions(){
const playerBox=new THREE.Box3().setFromObject(playerBody);
for(let v of vehicles){
const vehicleBox=new THREE.Box3().setFromObject(v);
if(playerBox.intersectsBox(vehicleBox)){die();return;}
}
}

function updatePlayer(dt){
if(!state.isPlaying)return;
const baseSpeed=state.isDashing?12:5;
const moveSpeed=baseSpeed*dt;
if(state.keys.forward&&playerGroup.position.z>-ROAD_LENGTH/2+5)playerGroup.position.z-=moveSpeed;
if(state.keys.backward&&playerGroup.position.z<ROAD_LENGTH/2-5)playerGroup.position.z+=moveSpeed;
if(state.keys.left&&playerGroup.position.x>-ROAD_WIDTH/2+2)playerGroup.position.x-=moveSpeed;
if(state.keys.right&&playerGroup.position.x<ROAD_WIDTH/2-2)playerGroup.position.x+=moveSpeed;
if(state.dashCooldown>0)state.dashCooldown-=dt;
if(state.isDashing&&state.dashCooldown<=0)state.isDashing=false;
if(playerGroup.position.z<=-ROAD_LENGTH/2+10)endGame(true);
checkCollisions();
}

function updateCamera(){
state.cameraAngle.x+=(state.targetCameraAngle.x-state.cameraAngle.x)*0.1;
state.cameraAngle.y+=(state.targetCameraAngle.y-state.cameraAngle.y)*0.1;
const distance=12;
const height=8;
camera.position.x=playerGroup.position.x+Math.sin(state.cameraAngle.y)*distance;
camera.position.y=playerGroup.position.y+height+Math.sin(state.cameraAngle.x)*5;
camera.position.z=playerGroup.position.z+Math.cos(state.cameraAngle.y)*distance;
camera.lookAt(playerGroup.position.x,playerGroup.position.y+1,playerGroup.position.z);
}

let spawnTimers=[0,0,0,0,0,0,0,0];
function updateSpawning(dt){
for(let i=0;i<NUM_LANES;i++){
spawnTimers[i]-=dt;
if(spawnTimers[i]<=0){spawnVehicle(i);spawnTimers[i]=0.5+Math.random()*1.5;}
}
}

let touchStart=null;
const swipeArea=document.getElementById('swipeArea');
swipeArea.addEventListener('touchstart',(e)=>{touchStart={x:e.touches[0].clientX,y:e.touches[0].clientY};},{passive:false});
swipeArea.addEventListener('touchmove',(e)=>{
if(!touchStart)return;
e.preventDefault();
const dx=e.touches[0].clientX-touchStart.x;
const dy=e.touches[0].clientY-touchStart.y;
state.targetCameraAngle.y-=dx*0.005;
state.targetCameraAngle.x-=dy*0.005;
state.targetCameraAngle.x=Math.max(-0.5,Math.min(0.8,state.targetCameraAngle.x));
touchStart={x:e.touches[0].clientX,y:e.touches[0].clientY};
},{passive:false});
swipeArea.addEventListener('touchend',()=>{touchStart=null;});

let isDragging=false,lastMouse=null;
swipeArea.addEventListener('mousedown',(e)=>{isDragging=true;lastMouse={x:e.clientX,y:e.clientY};});
window.addEventListener('mousemove',(e)=>{
if(!isDragging||!lastMouse)return;
const dx=e.clientX-lastMouse.x;
const dy=e.clientY-lastMouse.y;
state.targetCameraAngle.y-=dx*0.005;
state.targetCameraAngle.x-=dy*0.005;
state.targetCameraAngle.x=Math.max(-0.5,Math.min(0.8,state.targetCameraAngle.x));
lastMouse={x:e.clientX,y:e.clientY};
});
window.addEventListener('mouseup',()=>{isDragging=false;lastMouse=null;});

function setupButton(id,key){
const btn=document.getElementById(id);
const start=(e)=>{e.preventDefault();state.keys[key]=true;};
const end=(e)=>{e.preventDefault();state.keys[key]=false;};
btn.addEventListener('mousedown',start);
btn.addEventListener('mouseup',end);
btn.addEventListener('mouseleave',end);
btn.addEventListener('touchstart',start,{passive:false});
btn.addEventListener('touchend',end,{passive:false});
}
setupButton('btnForward','forward');
setupButton('btnBackward','backward');
setupButton('btnLeft','left');
setupButton('btnRight','right');

const dashBtn=document.getElementById('btnDash');
function startDash(e){
if(e)e.preventDefault();
if(state.dashCooldown<=0){state.isDashing=true;state.dashCooldown=0.5;}
}
dashBtn.addEventListener('mousedown',startDash);
dashBtn.addEventListener('touchstart',startDash,{passive:false});

document.getElementById('startBtn').addEventListener('click',startGame);
document.getElementById('restartBtn').addEventListener('click',startGame);

window.addEventListener('keydown',(e)=>{
if(e.key==='ArrowUp'||e.key==='w')state.keys.forward=true;
if(e.key==='ArrowDown'||e.key==='s')state.keys.backward=true;
if(e.key==='ArrowLeft'||e.key==='a')state.keys.left=true;
if(e.key==='ArrowRight'||e.key==='d')state.keys.right=true;
if(e.key===' ')startDash();
});
window.addEventListener('keyup',(e)=>{
if(e.key==='ArrowUp'||e.key==='w')state.keys.forward=false;
if(e.key==='ArrowDown'||e.key==='s')state.keys.backward=false;
if(e.key==='ArrowLeft'||e.key==='a')state.keys.left=false;
if(e.key==='ArrowRight'||e.key==='d')state.keys.right=false;
});

window.addEventListener('resize',()=>{
camera.aspect=window.innerWidth/window.innerHeight;
camera.updateProjectionMatrix();
renderer.setSize(window.innerWidth,window.innerHeight);
});

let lastTime=0;
function animate(time){
requestAnimationFrame(animate);
const dt=Math.min((time-lastTime)/1000,0.1);
lastTime=time;
if(state.isPlaying){
updateSpawning(dt);
updateVehicles(dt);
updatePlayer(dt);
}
updateCamera();
renderer.render(scene,camera);
}
resetPlayer();
updateCamera();
requestAnimationFrame(animate);
</script>
</body>
</html>